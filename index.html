<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>GPT-5o ChatBot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Fonts Link For Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
    /* CSS unchanged from your previous style */
      @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');
      * { margin:0; padding:0; box-sizing:border-box; font-family:"Poppins", sans-serif; }
      :root {
        --text-color:#FFFFFF; --icon-color:#ACACBE; --icon-hover-bg:#5b5e71;
        --placeholder-color:#dcdcdc; --outgoing-chat-bg:#343541; --incoming-chat-bg:#444654;
        --outgoing-chat-border:#343541; --incoming-chat-border:#444654;
      }
      .light-mode {
        --text-color:#343541; --icon-color:#a9a9bc; --icon-hover-bg:#f1f1f3;
        --placeholder-color:#6c6c6c; --outgoing-chat-bg:#FFFFFF; --incoming-chat-bg:#F7F7F8;
        --outgoing-chat-border:#FFFFFF; --incoming-chat-border:#D9D9E3;
      }
      body { background: var(--outgoing-chat-bg); }
      .chat-container { overflow-y:auto; max-height:100vh; padding-bottom:150px; }
      :where(.chat-container, textarea)::-webkit-scrollbar { width:6px; }
      :where(.chat-container, textarea)::-webkit-scrollbar-track { background:var(--incoming-chat-bg); border-radius:25px; }
      :where(.chat-container, textarea)::-webkit-scrollbar-thumb { background:var(--icon-color); border-radius:25px; }
      .default-text { display:flex; align-items:center; justify-content:center; flex-direction:column; height:70vh; padding:0 10px; text-align:center; color:var(--text-color); }
      .default-text h1 { font-size:3.3rem; }
      .default-text p { margin-top:10px; font-size:1.1rem; }
      .chat-container .chat { padding:25px 10px; display:flex; justify-content:center; color:var(--text-color); }
      .chat-container .chat.outgoing { background:var(--outgoing-chat-bg); border:1px solid var(--outgoing-chat-border); }
      .chat-container .chat.incoming { background:var(--incoming-chat-bg); border:1px solid var(--incoming-chat-border); }
      .chat .chat-content { display:flex; max-width:1200px; width:100%; align-items:flex-start; justify-content:space-between; }
      span.material-symbols-rounded { user-select:none; cursor:pointer; }
      .chat .chat-content span { cursor:pointer; font-size:1.3rem; color:var(--icon-color); visibility:hidden; }
      .chat:hover .chat-content:not(:has(.typing-animation), :has(.error)) span { visibility:visible; }
      .chat .chat-details { display:flex; align-items:center; }
      .chat .chat-details img { width:35px; height:35px; align-self:flex-start; object-fit:cover; border-radius:2px; }
      .chat .chat-details p { white-space:pre-wrap; font-size:1.05rem; padding:0 50px 0 25px; color:var(--text-color); word-break:break-word; }
      .chat .chat-details p.error { color:#e55865; }
      .chat .typing-animation { padding-left:25px; display:inline-flex; }
      .typing-animation .typing-dot { height:7px; width:7px; border-radius:50%; margin:0 3px; opacity:0.7; background:var(--text-color); animation: animateDots 1.5s var(--delay) ease-in-out infinite; }
      .typing-animation .typing-dot:first-child { margin-left:0; }
      @keyframes animateDots { 0%,44% { transform:translateY(0px); } 28% { opacity:0.4; transform:translateY(-6px); } 44% { opacity:0.2; } }
      .typing-container { position:fixed; bottom:0; width:100%; display:flex; padding:20px 10px; justify-content:center; background:var(--outgoing-chat-bg); border-top:1px solid var(--incoming-chat-border); }
      .typing-container .typing-content { display:flex; max-width:950px; width:100%; align-items:flex-end; }
      .typing-container .typing-textarea { width:100%; display:flex; position:relative; }
      .typing-textarea textarea { resize:none; height:55px; width:100%; border:none; padding:15px 45px 15px 20px; color:var(--text-color); font-size:1rem; border-radius:4px; max-height:250px; overflow-y:auto; background:var(--incoming-chat-bg); outline:1px solid var(--incoming-chat-border); }
      .typing-textarea textarea::placeholder { color:var(--placeholder-color); }
      .typing-content span { width:55px; height:55px; display:flex; border-radius:4px; font-size:1.35rem; align-items:center; justify-content:center; color:var(--icon-color); }
      .typing-textarea span { position:absolute; right:0; bottom:0; visibility:hidden; }
      .typing-textarea textarea:valid ~ span { visibility:visible; }
      .typing-controls { display:flex; }
      .typing-controls span { margin-left:7px; font-size:1.4rem; background:var(--incoming-chat-bg); outline:1px solid var(--incoming-chat-border); }
      .typing-controls span:hover { background:var(--icon-hover-bg); }
      @media screen and (max-width:600px) {
        .default-text h1 { font-size:2.3rem; }
        :where(.default-text p, textarea, .chat p) { font-size:0.95rem!important; }
        .chat-container .chat { padding:20px 10px; }
        .chat-container .chat img { height:32px; width:32px; }
        .chat-container .chat p { padding:0 20px; }
        .chat .chat-content:not(:has(.typing-animation), :has(.error)) span { visibility:visible; }
        .typing-container { padding:15px 10px; }
        .typing-textarea textarea { height:45px; padding:10px 40px 10px 10px; }
        .typing-content span { height:45px; width:45px; margin-left:5px; }
        span.material-symbols-rounded { font-size:1.25rem!important; }
      }
    </style>
  </head>
  <body>
    <div class="chat-container"></div>
    <div class="typing-container">
      <div class="typing-content">
        <div class="typing-textarea">
          <textarea id="chat-input" spellcheck="false" placeholder="Enter a prompt here" required></textarea>
          <span id="send-btn" class="material-symbols-rounded">send</span>
        </div>
        <div class="typing-controls">
          <span id="theme-btn" class="material-symbols-rounded">light_mode</span>
          <span id="delete-btn" class="material-symbols-rounded">delete</span>
        </div>
      </div>
    </div>

    <script>
    // Elements
const chatInput = document.querySelector("#chat-input");
const sendButton = document.querySelector("#send-btn");
const chatContainer = document.querySelector(".chat-container");
const themeButton = document.querySelector("#theme-btn");
const deleteButton = document.querySelector("#delete-btn");
const initialInputHeight = chatInput.scrollHeight;

let userText = "";
let isBotTyping = false; // new flag to block sending messages while bot is typing

// QA data (loaded from JSON)
let qaData = {};

// Create typing speed slider below chat input
const sliderContainer = document.createElement("div");
sliderContainer.style.display = "flex";
sliderContainer.style.alignItems = "center";
sliderContainer.style.marginTop = "5px";
sliderContainer.innerHTML = `
  <label style="margin-right:10px;">Typing Speed:</label>
  <input type="range" id="typing-speed-slider" min="50" max="500" value="${localStorage.getItem("typingSpeed") || 100}" />
  <span id="typing-speed-value">${localStorage.getItem("typingSpeed") || 100} ms</span>
`;
document.querySelector(".typing-container .typing-content").appendChild(sliderContainer);

const typingSlider = document.getElementById("typing-speed-slider");
const typingValue = document.getElementById("typing-speed-value");

typingSlider.addEventListener("input", () => {
  localStorage.setItem("typingSpeed", typingSlider.value);
  typingValue.textContent = `${typingSlider.value} ms`;
});

// Fetch QA JSON on page load
async function loadQAData() {
  try {
    const response = await fetch("gpt-5o.json");
    if (!response.ok) throw new Error("Failed to load gpt-5o.json");
    qaData = await response.json();
  } catch (error) {
    console.error("Error loading QA data:", error);
    qaData = { "GPT-5o": [] };
  }
}

// LocalStorage & Theme
const loadDataFromLocalstorage = () => {
  const theme = localStorage.getItem("themeColor");
  document.body.classList.toggle("light-mode", theme === "light_mode");

  const defaultText = `<div class="default-text"><h1>GPT-5o ChatBot</h1>
    <p>Start a conversation.<br>Your chat history will appear here.</p></div>`;
  chatContainer.innerHTML = localStorage.getItem("all-chats") || defaultText;
  chatContainer.scrollTo(0, chatContainer.scrollHeight);
};

// Chat creation
const createChatElement = (content, className) => {
  const div = document.createElement("div");
  div.classList.add("chat", className);
  div.innerHTML = content;
  return div;
};

// Markov chain generator
function buildMarkovChain(textArray) {
  const markov = {};
  textArray.forEach(sentence => {
    const words = sentence.split(/\s+/);
    for (let i = 0; i < words.length - 1; i++) {
      const word = words[i].toLowerCase();
      const nextWord = words[i + 1].toLowerCase();
      if (!markov[word]) markov[word] = [];
      markov[word].push(nextWord);
    }
  });
  return markov;
}

function generateMarkovResponse(chain, startWord = null, length = 20) {
  const keys = Object.keys(chain);
  let word = startWord || keys[Math.floor(Math.random() * keys.length)];
  const result = [word];
  for (let i = 0; i < length; i++) {
    const nextWords = chain[word];
    if (!nextWords || nextWords.length === 0) break;
    word = nextWords[Math.floor(Math.random() * nextWords.length)];
    result.push(word);
  }
  return result.join(" ");
}

// Generate response using Markov chain + conversation context
function getContextAwareResponse(userText) {
  const pastChats = localStorage.getItem("all-chats") || "";
  const qaItems = qaData["GPT-5o"] || [];
  const answers = qaItems.map(a => a.answer);
  const combinedText = answers.concat(pastChats.split(/<p>|<\/p>/).filter(Boolean));
  const chain = buildMarkovChain(combinedText);

  let startWord = null;
  for (let item of qaItems) {
    if (userText.toLowerCase().includes(item.question.toLowerCase())) {
      startWord = item.answer.split(" ")[0].toLowerCase();
      break;
    }
  }
  return generateMarkovResponse(chain, startWord, 25);
}

// Display text gradually, 2-4 words per chunk, delay from localStorage
function displayTextGradually(element, text, callback) {
  isBotTyping = true;
  const delay = parseInt(localStorage.getItem("typingSpeed")) || 100;

  const words = text.split(" ");
  let i = 0;

  function addWords() {
    if (i >= words.length) {
      isBotTyping = false;
      if (callback) callback();
      return;
    }
    const chunkSize = Math.floor(Math.random() * 3) + 2; // 2-4 words
    const chunk = words.slice(i, i + chunkSize).join(" ");
    element.textContent += (element.textContent ? " " : "") + chunk;
    i += chunkSize;
    setTimeout(addWords, delay);
  }

  addWords();
}

// Show bot typing with gradual text and GPT-5o profile image
const showTypingAnimation = () => {
  const html = `<div class="chat-content">
    <div class="chat-details">
      <img src="profile/gpt-5o.jpg" alt="chatbot-img">
      <div class="typing-animation">
        <div class="typing-dot" style="--delay:0.2s"></div>
        <div class="typing-dot" style="--delay:0.3s"></div>
        <div class="typing-dot" style="--delay:0.4s"></div>
      </div>
    </div></div>`;

  const incomingDiv = createChatElement(html, "incoming");
  chatContainer.appendChild(incomingDiv);
  chatContainer.scrollTo(0, chatContainer.scrollHeight);

  setTimeout(() => {
    const p = document.createElement("p");
    incomingDiv.querySelector(".typing-animation").remove();
    incomingDiv.querySelector(".chat-details").appendChild(p);

    const responseText = getContextAwareResponse(userText);
    displayTextGradually(p, responseText, () => {
      localStorage.setItem("all-chats", chatContainer.innerHTML);
      chatContainer.scrollTo(0, chatContainer.scrollHeight);
    });

  }, 800);
};

// Send chat with user profile image, block if bot typing
const handleOutgoingChat = () => {
  if (isBotTyping) return; // prevent sending while bot is typing
  userText = chatInput.value.trim();
  if (!userText) return;
  chatInput.value = "";
  chatInput.style.height = `${initialInputHeight}px`;

  const html = `<div class="chat-content">
    <div class="chat-details">
      <img src="profile/user.jpg" alt="user-img">
      <p>${userText}</p>
    </div></div>`;
  const outgoingDiv = createChatElement(html, "outgoing");
  chatContainer.querySelector(".default-text")?.remove();
  chatContainer.appendChild(outgoingDiv);
  chatContainer.scrollTo(0, chatContainer.scrollHeight);
  setTimeout(showTypingAnimation, 300);
};

// Event listeners
sendButton.addEventListener("click", handleOutgoingChat);
chatInput.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    handleOutgoingChat();
  }
});
chatInput.addEventListener("input", () => {
  chatInput.style.height = `${initialInputHeight}px`;
  chatInput.style.height = `${chatInput.scrollHeight}px`;
});
themeButton.addEventListener("click", () => {
  document.body.classList.toggle("light-mode");
  localStorage.setItem(
    "themeColor",
    document.body.classList.contains("light-mode") ? "light_mode" : "dark_mode"
  );
});
deleteButton.addEventListener("click", () => {
  if (confirm("Delete all chats?")) {
    localStorage.removeItem("all-chats");
    loadDataFromLocalstorage();
  }
});

// Initialize
(async function init() {
  await loadQAData();
  loadDataFromLocalstorage();
})();

    </script>
  </body>
</html>
